<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PFF Esports - Match Life Tracker (MVP)</title>
  <style>
    :root { --bg:#0f1115; --panel:#151823; --muted:#8a8fa3; --text:#e7e9f2; --primary:#3b82f6; --accent:#22c55e; --danger:#ef4444; --border:#23273a; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    h1 { font-size: 20px; margin: 0; font-weight: 700; }
    .grid { display: grid; grid-template-columns: 1fr 320px; gap: 16px; align-items: start; }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; align-items: center; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], select { width: 100%; padding: 10px 12px; border-radius: 8px; background: #0f1220; border: 1px solid var(--border); color: var(--text); }
    .section-title { margin: 14px 0 8px; font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .08em; }
    .score-row { display: flex; gap: 10px; }
    .score-btn { background: #0f1220; border: 1px solid var(--border); color: var(--text); padding: 10px 16px; border-radius: 8px; cursor: pointer; min-width: 44px; }
    .score-btn.active { border-color: var(--primary); background: rgba(59,130,246,.15); }
    .chips { display: flex; flex-wrap: wrap; gap: 10px; }
    .chip { border: 1px solid var(--border); background: #0f1220; padding: 8px 12px; border-radius: 999px; display: inline-flex; gap: 8px; align-items: center; cursor: pointer; user-select: none; }
    .chip input { accent-color: var(--primary); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button.primary { background: var(--primary); color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
    button.ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); padding: 10px 14px; border-radius: 8px; cursor: pointer; }
    button.danger { background: var(--danger); color: white; border: none; padding: 10px 14px; border-radius: 8px; cursor: pointer; }
    .lives { display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 170px); overflow: auto; }
    .life-item { background: #0f1220; border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px; display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .life-item .meta { font-size: 12px; color: var(--muted); }
    .life-item .title { font-weight: 600; }
    .life-item .tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .tag { background: rgba(59,130,246,.15); color: #cfe0ff; border: 1px solid rgba(59,130,246,.35); padding: 2px 8px; border-radius: 999px; font-size: 11px; }
    .life-actions { display: flex; gap: 6px; }
    .life-actions button { padding: 6px 10px; font-size: 12px; }
    .empty { color: var(--muted); font-size: 13px; text-align: center; padding: 18px; border: 1px dashed var(--border); border-radius: 10px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Game — Match Life Tracker</h1>
      <div class="actions">
        <button id="exportCsvBtn" class="ghost" title="Download CSV">Export CSV</button>
        <button id="resetBtn" class="danger" title="Clear current session">Reset Session</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel" aria-label="Life Input">
        <div class="row" style="margin-bottom: 10px;">
          <div style="grid-column: span 6;">
            <label for="matchLink">Input Match Link</label>
            <input id="matchLink" type="text" placeholder="https://..." autocomplete="off">
          </div>
          <div style="grid-column: span 3;">
            <label for="playerSelect">Select Player</label>
            <select id="playerSelect">
              <option value="">– Select –</option>
              <option>Player 1</option>
              <option>Player 2</option>
              <option>Player 3</option>
              <option>Player 4</option>
              <option>Player 5</option>
            </select>
          </div>
          <div style="grid-column: span 3;">
            <label for="modeSelect">Select Game / Mode</label>
            <select id="modeSelect">
              <option value="">– Select –</option>
              <option>Hardpoint</option>
              <option>Search &amp; Destroy</option>
              <option>Control</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="section-title">Score the life overall</div>
        <div class="score-row" role="group" aria-label="Life Score">
          <button type="button" class="score-btn" data-score="-2">-2</button>
          <button type="button" class="score-btn" data-score="-1">-1</button>
          <button type="button" class="score-btn" data-score="0">0</button>
          <button type="button" class="score-btn" data-score="1">+1</button>
          <button type="button" class="score-btn" data-score="2">+2</button>
        </div>

        <div class="section-title">Select all that apply</div>
        <div class="chips">
          <label class="chip"><input id="goodFight" type="checkbox"> GOOD FIGHT</label>
          <label class="chip"><input id="goodRoute" type="checkbox"> GOOD ROUTE</label>
          <label class="chip"><input id="badRoute" type="checkbox"> BAD ROUTE</label>
          <label class="chip"><input id="gotSpawns" type="checkbox"> GOT SPAWNS</label>
          <label class="chip"><input id="lostSpawns" type="checkbox"> LOST SPAWNS</label>
          <label class="chip"><input id="freeKill" type="checkbox"> FREE KILL</label>
          <label class="chip"><input id="freeDeath" type="checkbox"> FREE DEATH</label>
        </div>

        <div class="actions">
          <button id="submitBtn" class="primary">Submit Life</button>
          <button id="cancelEditBtn" class="ghost" style="display:none;">Cancel Edit</button>
        </div>
      </section>

      <aside class="panel" aria-label="Lives List">
        <div class="section-title">List of Lives</div>
        <div id="lives" class="lives"></div>
      </aside>
    </div>
  </div>

  <script>
    (function() {
      const STORAGE_KEY = 'pff_esports_session_v1';

      /** @typedef {{match:string, player:string, mode:string, lifeNum:number, score:number, good_fight:number, good_route:number, bad_route:number, got_spawns:number, lost_spawns:number, free_kill:number, free_death:number}} Life */

      /** @type {{ match:string, player:string, mode:string, lives:Life[], nextLifeNum:number, editingIndex:number|null, selectedScore:number|null }} */
      const state = {
        match: '',
        player: '',
        mode: '',
        lives: [],
        nextLifeNum: 1,
        editingIndex: null,
        selectedScore: null
      };

      // Elements
      const matchLink = document.getElementById('matchLink');
      const playerSelect = document.getElementById('playerSelect');
      const modeSelect = document.getElementById('modeSelect');
      const scoreButtons = Array.from(document.querySelectorAll('.score-btn'));
      const chips = {
        goodFight: document.getElementById('goodFight'),
        goodRoute: document.getElementById('goodRoute'),
        badRoute: document.getElementById('badRoute'),
        gotSpawns: document.getElementById('gotSpawns'),
        lostSpawns: document.getElementById('lostSpawns'),
        freeKill: document.getElementById('freeKill'),
        freeDeath: document.getElementById('freeDeath')
      };
      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');
      const livesEl = document.getElementById('lives');
      const exportCsvBtn = document.getElementById('exportCsvBtn');
      const resetBtn = document.getElementById('resetBtn');

      // Load session
      loadFromStorage();
      bindEvents();
      renderLives();
      reflectHeaderInputs();
      reflectSelectedScore();

      function bindEvents() {
        matchLink.addEventListener('input', () => { state.match = matchLink.value.trim(); persist(); });
        playerSelect.addEventListener('change', () => { state.player = playerSelect.value; persist(); });
        modeSelect.addEventListener('change', () => { state.mode = modeSelect.value; persist(); });

        scoreButtons.forEach(btn => btn.addEventListener('click', () => {
          const score = Number(btn.getAttribute('data-score'));
          state.selectedScore = score;
          reflectSelectedScore();
        }));

        submitBtn.addEventListener('click', onSubmitLife);
        cancelEditBtn.addEventListener('click', clearEditMode);
        exportCsvBtn.addEventListener('click', exportCsv);
        resetBtn.addEventListener('click', resetSession);
      }

      function onSubmitLife() {
        if (!state.player || !state.mode) {
          alert('Please select a player and a game/mode first.');
          return;
        }
        if (state.selectedScore === null) {
          if (!confirm('No score selected. Submit with score = 0?')) return; else state.selectedScore = 0;
        }

        const life = /** @type {Life} */ ({
          match: state.match || '',
          player: state.player,
          mode: state.mode,
          lifeNum: state.editingIndex === null ? state.nextLifeNum : state.lives[state.editingIndex].lifeNum,
          score: Number(state.selectedScore),
          good_fight: chips.goodFight.checked ? 1 : 0,
          good_route: chips.goodRoute.checked ? 1 : 0,
          bad_route: chips.badRoute.checked ? 1 : 0,
          got_spawns: chips.gotSpawns.checked ? 1 : 0,
          lost_spawns: chips.lostSpawns.checked ? 1 : 0,
          free_kill: chips.freeKill.checked ? 1 : 0,
          free_death: chips.freeDeath.checked ? 1 : 0
        });

        if (state.editingIndex === null) {
          state.lives.push(life);
          state.nextLifeNum += 1;
        } else {
          state.lives[state.editingIndex] = life;
        }

        persist();
        renderLives();
        clearForm();
      }

      function renderLives() {
        livesEl.innerHTML = '';
        if (state.lives.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No lives recorded yet. Submit the first one to start.';
          livesEl.appendChild(empty);
          return;
        }
        state.lives
          .slice()
          .sort((a, b) => a.lifeNum - b.lifeNum)
          .forEach((life, index) => {
            const item = document.createElement('div');
            item.className = 'life-item';

            const left = document.createElement('div');
            const title = document.createElement('div');
            title.className = 'title';
            title.textContent = `Life ${life.lifeNum} — Score ${life.score}`;
            left.appendChild(title);

            const meta = document.createElement('div');
            meta.className = 'meta';
            const matchStr = life.match ? ` | ${life.match}` : '';
            meta.textContent = `${life.player} | ${life.mode}${matchStr}`;
            left.appendChild(meta);

            const tags = document.createElement('div');
            tags.className = 'tags';
            const tagList = [
              life.good_fight ? 'GOOD FIGHT' : null,
              life.good_route ? 'GOOD ROUTE' : null,
              life.bad_route ? 'BAD ROUTE' : null,
              life.got_spawns ? 'GOT SPAWNS' : null,
              life.lost_spawns ? 'LOST SPAWNS' : null,
              life.free_kill ? 'FREE KILL' : null,
              life.free_death ? 'FREE DEATH' : null
            ].filter(Boolean);
            if (tagList.length) {
              tagList.forEach(t => {
                const span = document.createElement('span');
                span.className = 'tag';
                span.textContent = t;
                tags.appendChild(span);
              });
            }
            left.appendChild(tags);

            const right = document.createElement('div');
            right.className = 'life-actions';
            const editBtn = document.createElement('button');
            editBtn.className = 'ghost';
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => startEdit(index));
            const delBtn = document.createElement('button');
            delBtn.className = 'danger';
            delBtn.textContent = 'Delete';
            delBtn.addEventListener('click', () => deleteLife(index));
            right.appendChild(editBtn);
            right.appendChild(delBtn);

            item.appendChild(left);
            item.appendChild(right);
            livesEl.appendChild(item);
          });
      }

      function startEdit(index) {
        const life = state.lives[index];
        state.editingIndex = index;
        state.match = life.match || '';
        state.player = life.player;
        state.mode = life.mode;
        state.selectedScore = life.score;

        matchLink.value = state.match;
        playerSelect.value = state.player;
        modeSelect.value = state.mode;
        chips.goodFight.checked = life.good_fight === 1;
        chips.goodRoute.checked = life.good_route === 1;
        chips.badRoute.checked = life.bad_route === 1;
        chips.gotSpawns.checked = life.got_spawns === 1;
        chips.lostSpawns.checked = life.lost_spawns === 1;
        chips.freeKill.checked = life.free_kill === 1;
        chips.freeDeath.checked = life.free_death === 1;

        submitBtn.textContent = 'Update Life';
        cancelEditBtn.style.display = '';
        reflectSelectedScore();
      }

      function deleteLife(index) {
        const life = state.lives[index];
        if (!confirm(`Delete Life ${life.lifeNum}?`)) return;
        state.lives.splice(index, 1);
        // Re-number lives to keep sequence tight
        state.lives.sort((a,b) => a.lifeNum - b.lifeNum).forEach((l, i) => l.lifeNum = i + 1);
        state.nextLifeNum = state.lives.length + 1;
        persist();
        renderLives();
        if (state.editingIndex === index) clearEditMode();
      }

      function clearForm() {
        state.selectedScore = null;
        Object.values(chips).forEach(chk => chk.checked = false);
        reflectSelectedScore();
        clearEditMode();
      }

      function clearEditMode() {
        state.editingIndex = null;
        submitBtn.textContent = 'Submit Life';
        cancelEditBtn.style.display = 'none';
        // Keep header inputs as-is; they are session-level
      }

      function reflectSelectedScore() {
        scoreButtons.forEach(btn => {
          const score = Number(btn.getAttribute('data-score'));
          btn.classList.toggle('active', state.selectedScore === score);
        });
      }

      function reflectHeaderInputs() {
        matchLink.value = state.match;
        playerSelect.value = state.player;
        modeSelect.value = state.mode;
      }

      function persist() {
        const data = {
          match: state.match,
          player: state.player,
          mode: state.mode,
          lives: state.lives,
          nextLifeNum: state.nextLifeNum
        };
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch {}
      }

      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          const saved = JSON.parse(raw);
          state.match = saved.match || '';
          state.player = saved.player || '';
          state.mode = saved.mode || '';
          state.lives = Array.isArray(saved.lives) ? saved.lives : [];
          state.nextLifeNum = Number(saved.nextLifeNum) || (state.lives.length + 1);
        } catch {}
      }

      function exportCsv() {
        if (state.lives.length === 0) { alert('No lives to export.'); return; }
        const rows = [];
        const headers = ['match','game_mode','player','life_num','score','good_route','bad_route','good_fight','got_spawns','lost_spawns','free_kill','free_death'];
        rows.push(headers);
        state.lives
          .slice()
          .sort((a,b) => a.lifeNum - b.lifeNum)
          .forEach(l => {
            rows.push([
              l.match || '',
              l.mode,
              l.player,
              String(l.lifeNum),
              String(l.score),
              String(l.good_route),
              String(l.bad_route),
              String(l.good_fight),
              String(l.got_spawns),
              String(l.lost_spawns),
              String(l.free_kill),
              String(l.free_death)
            ]);
          });
        const csv = rows.map(r => r.map(cell => needsCsvEscaping(cell) ? '"' + String(cell).replaceAll('"','""') + '"' : cell).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const playerSlug = state.player ? state.player.replace(/\s+/g,'_') : 'player';
        const modeSlug = state.mode ? state.mode.replace(/\s+/g,'_') : 'mode';
        a.href = url;
        a.download = `lives_${playerSlug}_${modeSlug}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function needsCsvEscaping(value) {
        return /[",\n]/.test(String(value));
      }

      function resetSession() {
        if (!confirm('This will clear all lives and session settings. Continue?')) return;
        try { localStorage.removeItem(STORAGE_KEY); } catch {}
        state.match = '';
        state.player = '';
        state.mode = '';
        state.lives = [];
        state.nextLifeNum = 1;
        state.editingIndex = null;
        state.selectedScore = null;
        reflectHeaderInputs();
        reflectSelectedScore();
        renderLives();
      }
    })();
  </script>
</body>
</html>


